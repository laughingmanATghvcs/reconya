{{define "components/device-modal.html"}}
<div class="bg-gray-800 border border-green-500 text-green-500 p-6 rounded-lg" data-device-id="{{.ID}}" style="max-width: 800px; margin: 0 auto; width: 90vw;">
    <!-- Header -->
    <div class="flex justify-between items-center mb-4 pb-3 border-b border-green-500">
        <div class="flex items-center">
            <div class="mr-3">
                {{if .OS}}
                    {{if contains .OS.Name "Windows"}}<i class="ti ti-brand-windows text-blue-400 text-xl" title="{{.OS.Name}}"></i>{{else if contains .OS.Name "Linux"}}<i class="ti ti-brand-ubuntu text-orange-400 text-xl" title="{{.OS.Name}}"></i>{{else if contains .OS.Name "macOS"}}<i class="ti ti-brand-apple text-gray-300 text-xl" title="{{.OS.Name}}"></i>{{else if contains .OS.Name "Android"}}<i class="ti ti-brand-android text-green-400 text-xl" title="{{.OS.Name}}"></i>{{else if contains .OS.Name "iOS"}}<i class="ti ti-device-mobile text-gray-300 text-xl" title="{{.OS.Name}}"></i>{{else}}<i class="ti ti-device-desktop text-gray-400 text-xl" title="{{.OS.Name}}"></i>{{end}}
                {{else}}
                    <i class="ti ti-router text-gray-400 text-xl" title="Unknown Device"></i>
                {{end}}
            </div>
            <div>
                <div class="font-bold text-xl text-white">{{.IPv4}}</div>
                <div class="text-gray-300 text-sm" id="name-display">{{or .Name (deref .Hostname) "Unnamed Device"}}</div>
                <input type="text" id="name-edit" class="w-full px-3 py-2 bg-gray-700 text-white border border-green-500 rounded text-sm" 
                       value="{{or .Name (deref .Hostname)}}" data-original="{{or .Name (deref .Hostname)}}" placeholder="Device name" style="display: none;">
            </div>
        </div>
        <div class="flex items-center gap-2">
            <div id="edit-buttons">
                <button type="button" class="border border-green-500 text-green-500 hover:bg-green-500 hover:text-white px-3 py-1.5 rounded text-sm transition-colors" onclick="toggleEditMode()" title="Edit device">
                    <i class="ti ti-edit"></i>
                </button>
            </div>
            <button type="button" class="text-red-500 hover:text-red-400 px-2 py-1 rounded" onclick="deleteDevice('{{.ID}}', '{{.IPv4}}')" title="Delete device">
                <i class="ti ti-trash"></i>
            </button>
            <button type="button" class="text-gray-400 hover:text-white text-xl" onclick="closeModal('deviceModal')" aria-label="Close">
                <i class="ti ti-x"></i>
            </button>
        </div>
    </div>

    <!-- Key Info Grid -->
    <div class="grid grid-cols-2 gap-2 mb-3">
        <div>
            <div class="text-gray-400 text-sm">Status</div>
            <div>
                {{if eq .Status "online"}}
                    <span class="bg-green-600 text-white px-2 py-1 rounded text-xs font-medium">Online</span>
                {{else if eq .Status "idle"}}
                    <span class="bg-yellow-600 text-white px-2 py-1 rounded text-xs font-medium">Idle</span>
                {{else}}
                    <span class="bg-gray-600 text-white px-2 py-1 rounded text-xs font-medium">Offline</span>
                {{end}}
            </div>
        </div>
        <div>
            <div class="text-gray-400 text-sm">Ports</div>
            <div>
                {{$open := 0}}
                {{range .Ports}}
                    {{if eq .State "open"}}{{$open = add $open 1}}{{end}}
                {{end}}
                {{if gt $open 0}}
                    <span class="bg-red-600 text-white px-2 py-1 rounded text-xs font-medium">{{$open}} open</span>
                {{else}}
                    <span class="text-gray-400">-</span>
                {{end}}
            </div>
        </div>
        {{if deref .MAC}}
        <div>
            <div class="text-gray-400 text-sm">MAC Address</div>
            <div><code class="text-blue-400 text-xs bg-gray-900 px-2 py-1 rounded">{{deref .MAC}}</code></div>
        </div>
        {{end}}
        {{if deref .Vendor}}
        <div>
            <div class="text-gray-400 text-sm">Vendor</div>
            <div class="text-sm">{{deref .Vendor}}</div>
        </div>
        {{end}}
        {{if .OS}}
        <div class="col-span-2">
            <div class="text-gray-400 text-sm">Operating System</div>
            <div>{{.OS.Name}}{{if .OS.Version}} {{.OS.Version}}{{end}}</div>
        </div>
        {{end}}
        <div>
            <div class="text-gray-400 text-sm">Last Seen</div>
            <div class="text-sm">{{formatTimeAgo (deref .LastSeenOnlineAt)}}</div>
        </div>
    </div>

    <!-- Comments Section -->
    {{if or (deref .Comment) (eq "true" "true")}}
    <div class="mb-3">
        <div class="text-gray-400 text-sm mb-2">Comments</div>
        <div class="border border-green-500 rounded p-3">
            <div id="comment-display-section" style="{{if not (deref .Comment)}}display: none;{{end}}">
                <div class="text-gray-200 text-sm whitespace-pre-wrap" id="comment-display">{{deref .Comment}}</div>
            </div>
            <div id="comment-edit-section" style="display: none;">
                <textarea id="comment-edit" class="w-full px-3 py-2 bg-gray-700 text-white border border-green-500 rounded text-sm resize-y" 
                          placeholder="Add a comment..." 
                          style="min-height: 60px;" 
                          data-original="{{deref .Comment}}"
                          oninput="autoExpandTextarea(this)">{{deref .Comment}}</textarea>
            </div>
            <div id="comment-empty-section" style="{{if (deref .Comment)}}display: none;{{end}}">
                <div class="text-gray-400 text-sm text-center py-2">
                    <i class="ti ti-message mr-1"></i>No comments yet
                </div>
            </div>
        </div>
    </div>
    {{end}}

    <!-- Open Ports -->
    {{if gt $open 0}}
    <div class="mb-3">
        <div class="text-gray-400 text-sm mb-2">Ports ({{$open}})</div>
        <div class="flex flex-wrap gap-1">
            {{range .Ports}}
                {{if eq .State "open"}}
                <span class="bg-red-600 text-white px-2 py-1 rounded text-xs font-medium">
                    {{.Number}}
                    {{$portNum := .Number}}
                    {{$ipAddr := $.IPv4}}
                    {{if or (eq $portNum "80") (eq $portNum "8080") (eq $portNum "8000") (eq $portNum "443") (eq $portNum "8443")}}
                        <a href="{{if or (eq $portNum "443") (eq $portNum "8443")}}https{{else}}http{{end}}://{{$ipAddr}}:{{$portNum}}" target="_blank" rel="noopener noreferrer" class="text-white ml-1">
                            <i class="ti ti-external-link text-xs"></i>
                        </a>
                    {{end}}
                </span>
                {{end}}
            {{end}}
        </div>
    </div>
    {{end}}

    <!-- Web Services -->
    {{if and $.ScreenshotsEnabled .WebServices}}
    <div class="mb-3">
        <div class="text-gray-400 text-sm mb-2">Web Services ({{len .WebServices}})</div>
        {{range .WebServices}}
        <div class="border border-green-500 rounded p-3 mb-2">
            <div class="flex items-center justify-between">
                <div>
                    <a href="{{.URL}}" target="_blank" rel="noopener noreferrer" class="text-green-400 no-underline text-sm hover:text-green-300">
                        {{if eq .Protocol "https"}}<i class="ti ti-lock mr-1"></i>{{else}}<i class="ti ti-world mr-1"></i>{{end}}
                        {{.URL}} <i class="ti ti-external-link ml-1 text-xs"></i>
                    </a>
                    <div class="text-gray-400 text-xs">{{or .Title "No title"}}</div>
                </div>
                <span class="px-2 py-1 rounded text-xs font-medium {{if and (ge .StatusCode 200) (lt .StatusCode 300)}}bg-green-600 text-white{{else if and (ge .StatusCode 400) (lt .StatusCode 500)}}bg-yellow-600 text-black{{else if ge .StatusCode 500}}bg-red-600 text-white{{else}}bg-gray-600 text-white{{end}}">{{.StatusCode}}</span>
            </div>
        </div>
        {{end}}
    </div>
    {{end}}
</div>

<script>
// Use window object to avoid redeclaration errors
if (typeof window.deviceModalIsEditing === 'undefined') {
    window.deviceModalIsEditing = false;
}

function autoExpandTextarea(textarea) {
    // Reset height to auto to get the correct scrollHeight
    textarea.style.height = 'auto';
    // Set height to match content, with minimum height
    const minHeight = 60; // minimum height in pixels
    const newHeight = Math.max(minHeight, textarea.scrollHeight);
    textarea.style.height = newHeight + 'px';
}

function toggleEditMode() {
    window.deviceModalIsEditing = !window.deviceModalIsEditing;
    const editButtons = document.getElementById('edit-buttons');
    const nameDisplay = document.getElementById('name-display');
    const nameEdit = document.getElementById('name-edit');
    const commentDisplaySection = document.getElementById('comment-display-section');
    const commentEditSection = document.getElementById('comment-edit-section');
    const commentEmptySection = document.getElementById('comment-empty-section');
    const commentEdit = document.getElementById('comment-edit');
    
    if (window.deviceModalIsEditing) {
        // Switch to edit mode
        nameDisplay.style.display = 'none';
        nameEdit.style.display = 'block';
        
        // Hide display and empty sections, show edit section
        commentDisplaySection.style.display = 'none';
        commentEmptySection.style.display = 'none';
        commentEditSection.style.display = 'block';
        
        // Auto-expand textarea to fit content
        setTimeout(() => {
            autoExpandTextarea(commentEdit);
        }, 10);
        
        editButtons.innerHTML = `
            <button type="button" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm transition-colors" onclick="saveChanges()" title="Save changes">
                <i class="ti ti-check"></i>
            </button>
            <button type="button" class="border border-gray-500 text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-1.5 rounded text-sm transition-colors" onclick="cancelEdit()" title="Cancel editing">
                <i class="ti ti-x"></i>
            </button>
        `;
    } else {
        // Switch to display mode
        nameDisplay.style.display = 'block';
        nameEdit.style.display = 'none';
        
        // Hide edit section, show appropriate display section
        commentEditSection.style.display = 'none';
        const hasComment = commentEdit.value.trim() !== '';
        commentDisplaySection.style.display = hasComment ? 'block' : 'none';
        commentEmptySection.style.display = hasComment ? 'none' : 'block';
        
        editButtons.innerHTML = `
            <button type="button" class="border border-green-500 text-green-500 hover:bg-green-500 hover:text-white px-3 py-1.5 rounded text-sm transition-colors" onclick="toggleEditMode()" title="Edit device">
                <i class="ti ti-edit"></i>
            </button>
        `;
    }
}

function cancelEdit() {
    const nameEdit = document.getElementById('name-edit');
    const commentEdit = document.getElementById('comment-edit');
    
    // Reset to original values
    nameEdit.value = nameEdit.getAttribute('data-original') || '';
    commentEdit.value = commentEdit.getAttribute('data-original') || '';
    
    toggleEditMode();
}

function saveChanges() {
    const editButtons = document.getElementById('edit-buttons');
    if (!editButtons) {
        console.error('Edit buttons not found!');
        return;
    }
    
    const modalContent = editButtons.closest('[data-device-id]');
    if (!modalContent) {
        console.error('Modal content not found!');
        return;
    }
    
    const deviceId = modalContent.dataset.deviceId;
    if (!deviceId) {
        console.error('Device ID not found in modal data!');
        return;
    }
    
    const nameEdit = document.getElementById('name-edit');
    const commentEdit = document.getElementById('comment-edit');
    
    if (!nameEdit || !commentEdit) {
        console.error('Edit fields not found!');
        return;
    }
    
    const updateData = {
        hostname: nameEdit.value,
        comment: commentEdit.value
    };
    
    console.log('Updating device:', deviceId, 'with data:', updateData);
    
    // Show saving indicator
    editButtons.innerHTML = `
        <button type="button" class="bg-green-600 text-white px-3 py-1.5 rounded text-sm opacity-50 cursor-not-allowed" disabled>
            <span class="animate-spin rounded-full h-3 w-3 border-2 border-white border-t-transparent inline-block mr-1"></span>
            Saving...
        </button>
    `;
    
    // Use fetch instead of HTMX to avoid triggering the global modal event listener
    fetch(`/api/devices/${deviceId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams(updateData)
    }).then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.text();
    }).then(function(responseText) {
        console.log('Save successful, response:', responseText);
        // Success - update the display values
        const nameDisplay = document.getElementById('name-display');
        const commentDisplay = document.getElementById('comment-display');
        const commentDisplaySection = document.getElementById('comment-display-section');
        const commentEmptySection = document.getElementById('comment-empty-section');
        
        if (nameDisplay) {
            nameDisplay.textContent = nameEdit.value || '-';
        }
        if (commentDisplay) {
            // Use textContent to preserve line breaks with CSS white-space: pre-wrap
            commentDisplay.textContent = commentEdit.value;
        }
        
        // Show/hide appropriate comment sections
        const hasComment = commentEdit.value.trim() !== '';
        if (commentDisplaySection && commentEmptySection) {
            commentDisplaySection.style.display = hasComment ? 'block' : 'none';
            commentEmptySection.style.display = hasComment ? 'none' : 'block';
        }
        
        // Switch back to display mode
        window.deviceModalIsEditing = false;
        toggleEditMode();
        
        // Only refresh if the name changed to avoid unnecessary layout shifts
        if (nameEdit.value !== nameEdit.getAttribute('data-original')) {
            const deviceListContainer = document.getElementById('device-list-container');
            const devicesContainer = document.getElementById('devices-container');
            if (deviceListContainer) {
                htmx.ajax('GET', '/api/device-list', { target: '#device-list-container' });
            }
            if (devicesContainer) {
                htmx.ajax('GET', '/api/devices', { target: '#devices-container' });
            }
        }
        
        console.log('Device updated successfully');
        
        // Show success toast notification
        const toastId = 'deviceSavedToast_' + Date.now();
        const toastHtml = `
            <div class="fixed top-4 right-4 z-50">
                <div id="${toastId}" class="bg-gray-800 border border-green-500 rounded p-4 shadow-lg">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center">
                            <i class="ti ti-circle-check-filled text-green-500 mr-2"></i>
                            <strong class="text-green-500">Success</strong>
                        </div>
                        <button type="button" class="text-gray-400 hover:text-white" onclick="document.getElementById('${toastId}').remove()">
                            <i class="ti ti-x"></i>
                        </button>
                    </div>
                    <div class="text-gray-200 text-sm">
                        Device updated successfully!
                    </div>
                </div>
            </div>
        `;
        
        // Add toast to body
        document.body.insertAdjacentHTML('beforeend', toastHtml);
        
        // Auto-remove toast after 3 seconds
        setTimeout(() => {
            const toastElement = document.getElementById(toastId);
            if (toastElement) {
                toastElement.remove();
            }
        }, 3000);
        
        // Close the modal
        closeModal('deviceModal');
    }).catch(function(error) {
        // Error handling
        console.error('Failed to update device:', error);
        console.error('Error details:', error.message);
        
        // Reset edit buttons
        editButtons.innerHTML = `
            <button type="button" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm transition-colors" onclick="saveChanges()" title="Save changes">
                <i class="ti ti-check"></i>
            </button>
            <button type="button" class="border border-gray-500 text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-1.5 rounded text-sm transition-colors" onclick="cancelEdit()" title="Cancel editing">
                <i class="ti ti-x"></i>
            </button>
        `;
        
        // Show error message
        alert('Failed to update device. Please try again.');
    });
}

function openScreenshotModal(url, screenshot) {
    const modal = document.createElement('div');
    modal.className = 'modal show';
    modal.style.cssText = 'display: flex; background-color: rgba(0,0,0,0.8); z-index: 2000;';
    
    // Cleanup function
    const closeModal = () => {
        modal.remove();
    };
    
    modal.onclick = (e) => {
        if (e.target === modal) {
            closeModal();
        }
    };
    
    modal.innerHTML = `
        <div class="flex justify-center items-center w-full">
            <div class="bg-gray-900 border border-green-500 rounded max-w-6xl w-full mx-4">
                <div class="border-b border-green-500 p-4">
                    <div class="flex justify-between items-center">
                        <h5 class="text-green-500 font-bold">Screenshot - ${url}</h5>
                        <button type="button" class="text-gray-400 hover:text-white text-lg" onclick="closeScreenshotModal(this)">
                            <i class="ti ti-x"></i>
                        </button>
                    </div>
                </div>
                <div class="text-center p-2">
                    <img src="data:image/png;base64,${screenshot}" alt="Screenshot of ${url}" 
                         class="max-w-full max-h-80vh object-contain">
                </div>
                <div class="border-t border-green-500 p-4 flex justify-end gap-2">
                    <button type="button" class="border border-gray-500 text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded text-sm" onclick="closeScreenshotModal(this)">Close</button>
                    <a href="${url}" target="_blank" rel="noopener noreferrer" class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded text-sm">
                        Open Website <i class="ti ti-external-link ml-1"></i>
                    </a>
                </div>
            </div>
        </div>
    `;
    
    // Add global close function
    window.closeScreenshotModal = function(element) {
        const modal = element.closest('.modal');
        if (modal) {
            modal.remove();
        }
    };
    
    document.body.appendChild(modal);
}

// Reset editing state when modal is closed
document.addEventListener('DOMContentLoaded', function() {
    // Reset editing state when device modal is closed (handled by closeModal function)
    window.deviceModalIsEditing = false;
});
</script>
{{end}}